name: Watch Good First Issues in Other Repos

on:
  schedule:
    - cron: "0 * * * *"   # 매 정시(UTC 기준)마다 한 번 실행
  workflow_dispatch: {}    # 수동 실행도 가능

jobs:
  build-matrix:
    runs-on: ubuntu-latest
    environment: GOOD_FIRST_ISSUE_REPO

    outputs:
      matrix: ${{ steps.parse.outputs.matrix }}

    steps:
      - name: Parse CSV variable into JSON matrix
        id: parse
        run: |
          # Environment variable에서 CSV 읽기
          csv="${{ vars.GOOD_FIRST_ISSUE_REPO }}"

          echo "CSV content:"
          echo "$csv"

          json="["

          # 각 줄: repo,label
          while IFS=',' read -r repo label; do
            repo=$(echo "$repo" | xargs)
            label=$(echo "$label" | xargs)

            if [ -n "$repo" ] && [ -n "$label" ]; then
              json="$json{\"repo\":\"$repo\",\"label\":\"$label\"},"
            fi
          done <<< "$csv"

          # 마지막 콤마 제거 + 배열 닫기
          json="${json%,}]"

          echo "Generated JSON:"
          echo "$json"

          echo "matrix=$json" >> "$GITHUB_OUTPUT"

  watch:
    needs: build-matrix
    runs-on: ubuntu-latest
    environment: GOOD_FIRST_ISSUE_REPO

    strategy:
      matrix:
        config: ${{ fromJSON(needs.build-matrix.outputs.matrix) }}

    env:
      GH_TOKEN: ${{ secrets.WATCH_FIRST_ISSUE_TOKEN }}
      SLACK_WEBHOOK_URL: ${{ secrets.WATCH_FIRST_ISSUE_SLACK_WEBHOOK_URL }}

    steps:
      - name: Validate secrets
        run: |
          if [ -z "$GH_TOKEN" ]; then
            echo "❌ Missing GH_TOKEN"
            exit 1
          fi
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "❌ Missing SLACK_WEBHOOK_URL"
            exit 1
          fi

      - name: Install jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Check and notify new issues
        env:
          TARGET_REPO: ${{ matrix.config.repo }}
          TARGET_LABEL: ${{ matrix.config.label }}
          SEARCH_WINDOW_MINUTES: "90"   # 최근 1시간 30분
        run: |
          echo "▶ Checking repo=${TARGET_REPO}, label=${TARGET_LABEL}"

          # 최근 N분 기준 시간(UTC)
          SINCE=$(date -u -d "$SEARCH_WINDOW_MINUTES minutes ago" '+%Y-%m-%dT%H:%M:%SZ')

          # GitHub Search Issues 쿼리 (open + label + created 이후)
          QUERY="repo:${TARGET_REPO} label:\"${TARGET_LABEL}\" is:issue state:open created:>=$SINCE"

          # URL 인코딩
          ENCODED_QUERY=$(python -c "import urllib.parse, sys; print(urllib.parse.quote(sys.argv[1]))" "$QUERY")

          API_URL="https://api.github.com/search/issues?q=${ENCODED_QUERY}&sort=created&order=asc&per_page=20"
          echo "API_URL: $API_URL"

          RESPONSE=$(curl -sS \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "$API_URL")

          TOTAL=$(echo "$RESPONSE" | jq -r '.total_count')

          if [ "$TOTAL" = "null" ] || [ "$TOTAL" -eq 0 ]; then
            echo "⏺ No new issues for ${TARGET_REPO}"
            exit 0
          fi

          echo "✅ Found $TOTAL new issue(s)"

          # 각 이슈를 슬랙으로 전송 (Block Kit 사용)
          echo "$RESPONSE" | jq -c '.items[]' | while read -r issue; do
            title=$(echo "$issue" | jq -r '.title')
            url=$(echo "$issue" | jq -r '.html_url')
            created_at=$(echo "$issue" | jq -r '.created_at')
            number=$(echo "$issue" | jq -r '.number')
            user=$(echo "$issue" | jq -r '.user.login')

            # jq 로 Block Kit payload 생성
            payload=$(jq -n \
              --arg repo "$TARGET_REPO" \
              --arg label "$TARGET_LABEL" \
              --arg number "$number" \
              --arg user "$user" \
              --arg created_at "$created_at" \
              --arg title "$title" \
              --arg url "$url" \
              '{
                text: ("New issue with " + $label + " (#" + $number + ")"),
                blocks: [
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": ("*New issue with* `" + $label + "`")
                    }
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": ("*Repo*\n`" + $repo + "`")
                      },
                      {
                        "type": "mrkdwn",
                        "text": ("*Issue*\n#" + $number)
                      },
                      {
                        "type": "mrkdwn",
                        "text": ("*Author*\n`" + $user + "`")
                      },
                      {
                        "type": "mrkdwn",
                        "text": ("*Created (UTC)*\n" + $created_at)
                      }
                    ]
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": ("*Title*\n" + $title)
                    }
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "Open issue",
                          "emoji": true
                        },
                        "url": $url
                      }
                    ]
                  }
                ]
              }')

            curl -sS -X POST -H "Content-Type: application/json" \
              --data "$payload" \
              "$SLACK_WEBHOOK_URL" >/dev/null
          done

