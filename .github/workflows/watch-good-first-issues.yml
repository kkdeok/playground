name: Watch Good First Issues in Other Repos

on:
  schedule:
    - cron: "0 * * * *"   # ë§¤ ì •ì‹œ(UTC ê¸°ì¤€)ë§ˆë‹¤ í•œ ë²ˆ ì‹¤í–‰
  workflow_dispatch: {}    # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  build-matrix:
    runs-on: ubuntu-latest
    environment: GOOD_FIRST_ISSUE_REPO

    outputs:
      matrix: ${{ steps.parse.outputs.matrix }}

    steps:
      - name: Parse CSV variable into JSON matrix
        id: parse
        run: |
          # Environment variableì—ì„œ CSV ì½ê¸°
          csv="${{ vars.GOOD_FIRST_ISSUE_REPO }}"

          echo "CSV content:"
          echo "$csv"

          json="["

          # ê° ì¤„: repo,label
          while IFS=',' read -r repo label; do
            repo=$(echo "$repo" | xargs)
            label=$(echo "$label" | xargs)

            if [ -n "$repo" ] && [ -n "$label" ]; then
              json="$json{\"repo\":\"$repo\",\"label\":\"$label\"},"
            fi
          done <<< "$csv"

          # ë§ˆì§€ë§‰ ì½¤ë§ˆ ì œê±° + ë°°ì—´ ë‹«ê¸°
          json="${json%,}]"

          echo "Generated JSON:"
          echo "$json"

          echo "matrix=$json" >> "$GITHUB_OUTPUT"

  watch:
    needs: build-matrix
    runs-on: ubuntu-latest
    environment: GOOD_FIRST_ISSUE_REPO

    strategy:
      matrix:
        config: ${{ fromJSON(needs.build-matrix.outputs.matrix) }}

    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

    steps:
      - name: Validate secrets
        run: |
          if [ -z "$GH_TOKEN" ]; then
            echo "âŒ Missing GH_TOKEN"
            exit 1
          fi
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "âŒ Missing SLACK_WEBHOOK_URL"
            exit 1
          fi

      - name: Install jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      - name: Check and notify new issues
        env:
          TARGET_REPO: ${{ matrix.config.repo }}
          TARGET_LABEL: ${{ matrix.config.label }}
          SEARCH_WINDOW_MINUTES: "120"   # ğŸ”¸ ìµœê·¼ 2ì‹œê°„(120ë¶„)
        run: |
          echo "â–¶ Checking repo=${TARGET_REPO}, label=${TARGET_LABEL}"

          # ìµœê·¼ Në¶„ ê¸°ì¤€ ì‹œê°„(UTC)
          SINCE=$(date -u -d "$SEARCH_WINDOW_MINUTES minutes ago" '+%Y-%m-%dT%H:%M:%SZ')

          # GitHub Search Issues ì¿¼ë¦¬ (open + label + created ì´í›„)
          QUERY="repo:${TARGET_REPO} label:\"${TARGET_LABEL}\" is:issue state:open created:>=$SINCE"

          # Python one-linerë¡œ URL ì¸ì½”ë”©
          ENCODED_QUERY=$(python -c "import urllib.parse, sys; print(urllib.parse.quote(sys.argv[1]))" "$QUERY")

          API_URL="https://api.github.com/search/issues?q=${ENCODED_QUERY}&sort=created&order=asc&per_page=20"

          echo "API_URL: $API_URL"

          RESPONSE=$(curl -sS \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "$API_URL")

          TOTAL=$(echo "$RESPONSE" | jq -r '.total_count')

          if [ "$TOTAL" = "null" ] || [ "$TOTAL" -eq 0 ]; then
            echo "âº No new issues for ${TARGET_REPO}"
            exit 0
          fi

          echo "âœ… Found $TOTAL new issue(s)"

          # ê° ì´ìŠˆë¥¼ ìŠ¬ë™ìœ¼ë¡œ ì „ì†¡
          echo "$RESPONSE" | jq -c '.items[]' | while read -r issue; do
            title=$(echo "$issue" | jq -r '.title')
            url=$(echo "$issue" | jq -r '.html_url')
            created_at=$(echo "$issue" | jq -r '.created_at')
            number=$(echo "$issue" | jq -r '.number')
            user=$(echo "$issue" | jq -r '.user.login')

            text="ğŸ†• *New issue with \`${TARGET_LABEL}\`*\n"
            text="${text}ğŸ“¦ Repo: \`${TARGET_REPO}\`\n"
            text="${text}ğŸ”¢ Issue: #${number}\n"
            text="${text}ğŸ‘¤ Author: \`${user}\`\n"
            text="${text}ğŸ•’ Created (UTC): ${created_at}\n\n"
            text="${text}ğŸ“ ${title}\n"
            text="${text}ğŸ”— ${url}"

            payload=$(jq -n --arg text "$text" '{text: $text}')

            curl -sS -X POST -H "Content-Type: application/json" \
              --data "$payload" \
              "$SLACK_WEBHOOK_URL" >/dev/null
          done
